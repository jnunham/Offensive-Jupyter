# -----------------------------
# Query for krbtgt Account and Last Password Change (robust version)
# -----------------------------

import pandas as pd
from datetime import datetime, timezone

krbtgt_query = """
MATCH (u:User)
WHERE toLower(u.name) CONTAINS "krbtgt"
RETURN
    u.name AS AccountName,
    u.pwdlastset AS PasswordLastSet
LIMIT 1
"""

# Run the query
df_krbtgt = run_query(krbtgt_query)

# Convert Unix timestamp to MM/DD/YYYY format using timezone-aware datetime
df_krbtgt['PasswordLastSet'] = df_krbtgt['PasswordLastSet'].apply(
    lambda ts: datetime.fromtimestamp(float(ts), tz=timezone.utc).strftime('%m/%d/%Y')
)

# Optional: export to CSV (includes readable date)
df_krbtgt.to_csv("krbtgt-password-info.csv", index=False)

# Display first result with readable date
df_krbtgt[['AccountName', 'PasswordLastSet']].head(1)
